name: Tests and Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest

    permissions:
      # Required to checkout the code
      contents: read
      # Required to put a comment into the pull-request
      pull-requests: write

    strategy:
      matrix:
        node-version: [24.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: npm run type-check

      - name: Build project
        run: npm run build

      - name: Run tests with coverage
        env:
          # CIç’°å¢ƒã§ã®AWSèªè¨¼ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ã®ç’°å¢ƒå¤‰æ•°
          AWS_REGION: us-east-1
          CI: true
        run: npm run test:coverage

      - name: Vitest Coverage Report
        uses: davelosert/vitest-coverage-report-action@v2
        if: always() && matrix.node-version == '24.x'
        continue-on-error: true
        with:
          name: 'ğŸ“Š AWS Port Forward CLI ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ'
          # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ã‚’Vitestè¨­å®šã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿
          vite-config-path: './vitest.config.ts'

      - name: Upload coverage to artifacts
        if: matrix.node-version == '24.x'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage/
          retention-days: 30

  test-e2e:
    name: End-to-End CLI Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Test CLI help commands
        run: |
          node dist/cli.js --help
          node dist/cli.js connect --help
          node dist/cli.js exec --help
          node dist/cli.js enable-exec --help

      - name: Test CLI version
        run: node dist/cli.js --version

      - name: Test CLI error handling
        run: |
          # ãƒ†ã‚¹ãƒˆ: ç„¡åŠ¹ãªã‚³ãƒãƒ³ãƒ‰
          if node dist/cli.js invalid-command 2>/dev/null; then
            echo "Error: Should fail with invalid command"
            exit 1
          else
            echo "âœ… Correctly failed with invalid command"
          fi

          # ãƒ†ã‚¹ãƒˆ: ç„¡åŠ¹ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³
          if node dist/cli.js connect --invalid-option 2>/dev/null; then
            echo "Error: Should fail with invalid option"
            exit 1
          else
            echo "âœ… Correctly failed with invalid option"
          fi

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [test, test-e2e]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.test.result }}" == "success" && "${{ needs.test-e2e.result }}" == "success" ]]; then
            echo "âœ… All tests passed! Quality gate: PASSED"
          else
            echo "âŒ Some tests failed. Quality gate: FAILED"
            echo "Unit/Integration tests: ${{ needs.test.result }}"
            echo "E2E tests: ${{ needs.test-e2e.result }}"
            exit 1
          fi

      - name: Quality summary
        run: |
          echo "## ğŸ¯ Quality Gate Summary"
          echo "- Unit Tests: ${{ needs.test.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"
          echo "- Integration Tests: ${{ needs.test.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"
          echo "- E2E Tests: ${{ needs.test-e2e.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"