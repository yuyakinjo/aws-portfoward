name: Tests and Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest

    permissions:
      # Required to checkout the code
      contents: read
      # Required to put a comment into the pull-request
      pull-requests: write

    strategy:
      matrix:
        bun-version: [1.3.2]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun ${{ matrix.bun-version }}
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ matrix.bun-version }}

      - name: Install dependencies
        run: bun install

      - name: Run TypeScript type check
        run: bun run type-check

      - name: Build project
        run: bun run build

      - name: Run tests with coverage
        env:
          # CIç’°å¢ƒã§ã®AWSèªè¨¼ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ã®ç’°å¢ƒå¤‰æ•°
          AWS_REGION: us-east-1
          CI: true
        run: bun run test:coverage

      - name: Upload coverage to artifacts
        if: matrix.bun-version == '1.3.2'
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: |
            coverage/
          retention-days: 30

  test-e2e:
    name: End-to-End CLI Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.2'

      - name: Install dependencies
        run: bun install

      - name: Build project
        run: bun run build

      - name: Test CLI help commands
        run: |
          bun dist/cli.js --help
          bun dist/cli.js connect --help
          bun dist/cli.js exec --help
          bun dist/cli.js enable-exec --help

      - name: Test CLI version
        run: bun dist/cli.js --version

      - name: Test CLI error handling
        run: |
          # ãƒ†ã‚¹ãƒˆ: ç„¡åŠ¹ãªã‚³ãƒãƒ³ãƒ‰
          if bun dist/cli.js invalid-command 2>/dev/null; then
            echo "Error: Should fail with invalid command"
            exit 1
          else
            echo "âœ… Correctly failed with invalid command"
          fi

          # ãƒ†ã‚¹ãƒˆ: ç„¡åŠ¹ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³
          if bun dist/cli.js connect --invalid-option 2>/dev/null; then
            echo "Error: Should fail with invalid option"
            exit 1
          else
            echo "âœ… Correctly failed with invalid option"
          fi

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [test, test-e2e]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [[ "${{ needs.test.result }}" == "success" && "${{ needs.test-e2e.result }}" == "success" ]]; then
            echo "âœ… All tests passed! Quality gate: PASSED"
          else
            echo "âŒ Some tests failed. Quality gate: FAILED"
            echo "Unit/Integration tests: ${{ needs.test.result }}"
            echo "E2E tests: ${{ needs.test-e2e.result }}"
            exit 1
          fi

      - name: Quality summary
        run: |
          echo "## ğŸ¯ Quality Gate Summary"
          echo "- Unit Tests: ${{ needs.test.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"
          echo "- Integration Tests: ${{ needs.test.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"
          echo "- E2E Tests: ${{ needs.test-e2e.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"