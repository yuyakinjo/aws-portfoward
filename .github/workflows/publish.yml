name: Publish Package to npm

# リリースが作成されたときに実行
on:
  release:
    types: [published]

# npm publish に必要な権限
permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # コードをチェックアウト
      - name: Checkout
        uses: actions/checkout@v5

      # Bun環境のセットアップ
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.2'

      # Node.js環境のセットアップ (npm publish用)
      - name: Setup Node.js for npm publish
        uses: actions/setup-node@v6
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'

      # 依存関係のインストール
      - name: Install dependencies
        run: bun install

      # TypeScriptの型チェック
      - name: TypeScript type check
        run: bun run type-check

      # Biomeでコード品質チェック
      - name: Code quality check
        run: bun run ci

      # プロジェクトのビルド
      - name: Build project
        run: bun run build

            # ビルド結果の確認
      - name: Verify build output
        run: |
          if [ ! -f "dist/cli.js" ]; then
            echo "❌ Build failed: dist/cli.js not found"
            exit 1
          fi
          echo "✅ Build successful: dist/cli.js exists"

      # npmに公開
      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}