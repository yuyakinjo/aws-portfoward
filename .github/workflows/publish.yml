name: Publish Package to npm

# ãƒªãƒªãƒ¼ã‚¹ãŒä½œæˆã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
on:
  release:
    types: [published]

# npm publish ã«å¿…è¦ãªæ¨©é™
permissions:
  contents: read
  id-token: write

concurrency:
  group: publish
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout
        uses: actions/checkout@v5

      # Bunç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.2'

      # Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (npm publishç”¨)
      - name: Setup Node.js for npm publish
        uses: actions/setup-node@v6
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: bun install

      # TypeScriptã®å‹ãƒã‚§ãƒƒã‚¯
      - name: TypeScript type check
        run: bun run type-check

      # Biomeã§ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
      - name: Code quality check
        run: bun run ci

      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run tests
        env:
          AWS_REGION: us-east-1
          CI: true
        run: bun run test

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰
      - name: Build project
        run: bun run build

            # ãƒ“ãƒ«ãƒ‰çµæœã®ç¢ºèª
      - name: Verify build output
        run: |
          if [ ! -f "dist/cli.js" ]; then
            echo "âŒ Build failed: dist/cli.js not found"
            exit 1
          fi
          echo "âœ… Build successful: dist/cli.js exists"

      # npmã«å…¬é–‹ï¼ˆProvenance + Trusted Publishingï¼‰
      - name: Publish to npm with Provenance and Trusted Publishing
        run: npm publish --provenance --access public
        # ğŸ” Trusted Publishingä½¿ç”¨ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ä¸è¦ï¼‰