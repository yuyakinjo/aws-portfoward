name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # dependabot PRã‹ã©ã†ã‹ã‚’åˆ¤å®š
  check-dependabot:
    name: Check if Dependabot PR
    runs-on: ubuntu-latest
    outputs:
      is-dependabot: ${{ steps.check.outputs.is-dependabot }}
      is-dev-dependency: ${{ steps.check.outputs.is-dev-dependency }}
    steps:
      - name: Check if PR is from dependabot
        id: check
        run: |
          echo "Checking PR author: ${{ github.event.pull_request.user.login }}"
          echo "PR title: ${{ github.event.pull_request.title }}"

          # dependabot ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
          if [[ "${{ github.event.pull_request.user.login }}" == "dependabot[bot]" ]]; then
            echo "is-dependabot=true" >> $GITHUB_OUTPUT
            echo "âœ… This is a dependabot PR"

            # é–‹ç™ºãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åã§åˆ¤å®šï¼‰
            if [[ "${{ github.event.pull_request.title }}" =~ dev-tools ]]; then
              echo "is-dev-dependency=true" >> $GITHUB_OUTPUT
              echo "âœ… This is a dev dependency update"
            else
              echo "is-dev-dependency=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ This is not a dev dependency update"
            fi
          else
            echo "is-dependabot=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ This is not a dependabot PR"
          fi

  # ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: check-dependabot
    if: needs.check-dependabot.outputs.is-dependabot == 'true'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.2'

      - name: Install dependencies
        run: bun install

      - name: Run TypeScript type check
        run: bun run type-check

      - name: Build project
        run: bun run build

      - name: Run tests with coverage
        env:
          AWS_REGION: us-east-1
          CI: true
        run: bun run test:coverage

      - name: Test CLI commands
        run: |
          bun dist/cli.js --help
          bun dist/cli.js connect --help
          bun dist/cli.js exec --help
          bun dist/cli.js enable-exec --help
          bun dist/cli.js --version

  # è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œ
  auto-merge:
    name: Auto-merge dependabot PR
    runs-on: ubuntu-latest
    needs: [check-dependabot, test]
    if: needs.check-dependabot.outputs.is-dependabot == 'true' && needs.test.result == 'success'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Enable auto-merge
        run: |
          echo "ğŸš€ All tests passed! Enabling auto-merge for dependabot PR"
          gh pr merge --auto --squash "${{ github.event.pull_request.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

      - name: Add comment
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¤– **è‡ªå‹•ãƒãƒ¼ã‚¸ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ**\n\nâœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ\nğŸ”„ å¿…è¦ãªæ‰¿èªã‚’å¾—ã‚‰ã‚Œæ¬¡ç¬¬ã€è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™'
            })

  # è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸå ´åˆã®é€šçŸ¥
  skip-auto-merge:
    name: Skip auto-merge notification
    runs-on: ubuntu-latest
    needs: [check-dependabot, test]
    if: needs.check-dependabot.outputs.is-dependabot == 'true' && needs.test.result != 'success'

    permissions:
      pull-requests: write

    steps:
      - name: Add skip comment
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¤– **è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ**\n\nâŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸãŸã‚ã€è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ\n\næ‰‹å‹•ã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æ‰¿èªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚'
            })